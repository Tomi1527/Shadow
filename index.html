<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Login & Dashboard</title>
<style>
body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #121212; margin: 0; }
.centered { display: flex; justify-content: center; align-items: center; height: 100vh; }
#loginBox, #dashboard { background-color: #1e1e1e; padding: 40px 50px; border-radius: 20px; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.7); width: 400px; color: #fff; }
input { display: block; margin: 15px 0; padding: 15px 10px; width: 100%; border-radius: 12px; border: none; outline: none; font-size: 16px; background-color: #2c2c2c; color: #fff; }
input::placeholder { color: #aaa; }
button { padding: 15px; width: 100%; border: none; border-radius: 12px; background-color: #4CAF50; color: white; font-size: 18px; cursor: pointer; transition: 0.3s; }
button:hover { background-color: #45a049; }
#error { color: #ff6b6b; margin-top: 15px; font-weight: bold; }
.user-list { list-style: none; padding: 0; margin: 0; }
.user-list li { padding: 10px; cursor: pointer; border-bottom: 1px solid #333; }
.user-list li:hover { background-color: #333; }
.log-list { margin-top: 20px; }
.log-item { padding: 5px 0; border-bottom: 1px solid #333; }
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
<div class="centered" id="loginContainer">
  <div id="loginBox">
    <h2>Login</h2>
    <input type="text" id="username" placeholder="Benutzername">
    <input type="password" id="password" placeholder="Passwort">
    <button onclick="login()">Login</button>
    <div id="error"></div>
  </div>
</div>

<div class="centered" id="dashboardContainer" style="display:none;">
  <div id="dashboard">
    <h2>Admin Dashboard</h2>
    <h3>Benutzerübersicht</h3>
    <ul class="user-list" id="userList"></ul>
    <div class="log-list" id="logList"></div>
    <button onclick="logout()">Logout</button>
  </div>
</div>

<script>
const admins = [
  { user: "Mister X", pass: "test" },
  { user: "Void", pass: "Tomi0815!" },
  { user: "admin", pass: "admin123!" } // Admin-User für Dashboard
];

// Supabase konfigurieren
const supabaseUrl = 'https://xkflcxzifnpkhkmlzdoa.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhrZmxjeHppZm5wa2hrbWx6ZG9hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1NjA4MDIsImV4cCI6MjA3MDEzNjgwMn0.QizK419VRChe2lHwF1hBldTnxqV2j1c1moScB_YL-dg';
const supabase = Supabase.createClient(supabaseUrl, supabaseKey);

async function login() {
  const username = document.getElementById("username").value;
  const password = document.getElementById("password").value;
  const user = admins.find(u => u.user === username && u.pass === password);

  if (user) {
    sessionStorage.setItem('loggedIn', 'true');
    sessionStorage.setItem('username', username);

    // Log in Supabase speichern
    await supabase.from('login_logs').insert([
      { username: username, logged_in_at: new Date().toISOString() }
    ]);

    if(username === 'admin') {
      showDashboard();
    } else {
      alert("Erfolgreich eingeloggt!");
    }

    document.getElementById("loginContainer").style.display = 'none';
  } else {
    document.getElementById("error").innerText = "Benutzername oder Passwort falsch!";
  }
}

async function showDashboard() {
  document.getElementById("dashboardContainer").style.display = 'flex';
  const { data, error } = await supabase
    .from('login_logs')
    .select('*')
    .order('logged_in_at', { ascending: false });

  if(error) return console.error(error);

  const users = [...new Set(data.map(item => item.username))];
  const userList = document.getElementById("userList");
  userList.innerHTML = '';
  users.forEach(u => {
    const li = document.createElement('li');
    li.innerText = u;
    li.onclick = () => showUserLogs(u, data);
    userList.appendChild(li);
  });
}

function showUserLogs(username, allData) {
  const logs = allData.filter(l => l.username === username);
  const logList = document.getElementById("logList");
  logList.innerHTML = `<h4>Login-Verlauf für ${username}</h4>`;
  logs.forEach(l => {
    const div = document.createElement('div');
    div.className = 'log-item';
    div.innerText = new Date(l.logged_in_at).toLocaleString();
    logList.appendChild(div);
  });
}

function logout() {
  sessionStorage.clear();
  document.getElementById("dashboardContainer").style.display = 'none';
  document.getElementById("loginContainer").style.display = 'flex';
}

// Direkt weiterleiten oder Dashboard anzeigen, wenn bereits eingeloggt
if(sessionStorage.getItem('loggedIn') === 'true'){
  const username = sessionStorage.getItem('username');
  document.getElementById("loginContainer").style.display = 'none';
  if(username === 'admin') showDashboard();
  else alert("Erfolgreich eingeloggt!");
}
</script>
</body>
</html>
