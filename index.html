<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Shadow Aktensystem</title>
  <meta name="description" content="Kostenloses Aktensystem mit Supabase-Sync. Dark Mode, Suche, Sortierung, Einträge/Logs, Export/Import. Läuft statisch auf GitHub Pages." />
  <!-- TailwindCSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { darkMode: 'class' };
  </script>
  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    html { scroll-behavior: smooth; }
    input[type=file] { display: none; }
  </style>
</head>
<body class="bg-gray-900 text-gray-100">
  <!-- App Container -->
  <div class="min-h-screen max-w-6xl mx-auto px-4 py-6">
    <!-- Header -->
    <header class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-3 mb-6">
      <div>
        <h1 class="text-3xl font-bold tracking-tight">Shadow AkteManager</h1>
        <p class="text-sm text-gray-400"></p>
      </div>
      <div class="flex flex-wrap gap-2">
        <button id="btnConfig" class="px-4 py-2 rounded-2xl bg-gray-700 text-white shadow hover:bg-gray-600">Verbinden</button>
        <button id="btnAdd" class="px-4 py-2 rounded-2xl bg-blue-600 text-white shadow hover:bg-blue-700">Neue Person</button>
        <label for="importFile" class="px-4 py-2 rounded-2xl bg-gray-800 border shadow hover:bg-gray-700 cursor-pointer">Import JSON</label>
        <input id="importFile" type="file" accept="application/json" />
        <button id="btnExport" class="px-4 py-2 rounded-2xl bg-gray-800 border shadow hover:bg-gray-700">Export JSON</button>
        <button id="btnReset" class="px-4 py-2 rounded-2xl bg-red-800 text-red-100 border border-red-700 hover:bg-red-700">Alles löschen</button>
      </div>
    </header>

    <!-- Toolbar -->
    <section class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
      <div class="col-span-2 flex items-center gap-2">
        <input id="search" type="search" placeholder="Suche nach Name, Telefon, Fraktion…" class="w-full px-4 py-2 rounded-2xl border shadow bg-gray-800 focus:outline-none focus:ring focus:ring-blue-500" />
      </div>
      <div class="flex items-center gap-2 justify-between md:justify-end">
        <select id="sortBy" class="px-3 py-2 rounded-2xl border bg-gray-800 shadow">
          <option value="updatedAt-desc">Zuletzt geändert ↓</option>
          <option value="updatedAt-asc">Zuletzt geändert ↑</option>
          <option value="createdAt-desc">Erstellt ↓</option>
          <option value="createdAt-asc">Erstellt ↑</option>
          <option value="name-asc">Name A–Z</option>
          <option value="name-desc">Name Z–A</option>
        </select>
        <span id="count" class="text-sm text-gray-400"></span>
      </div>
    </section>

    <!-- Table -->
    <section class="bg-gray-800 rounded-2xl shadow overflow-hidden">
      <div class="overflow-x-auto">
        <table class="min-w-full border-collapse">
          <thead class="bg-gray-700 text-left text-sm">
            <tr>
              <th class="px-4 py-3">Name</th>
              <th class="px-4 py-3">Telefon</th>
              <th class="px-4 py-3">Fraktion</th>
              <th class="px-4 py-3">Geändert</th>
              <th class="px-4 py-3">Aktionen</th>
            </tr>
          </thead>
          <tbody id="tableBody" class="text-sm"></tbody>
        </table>
      </div>
    </section>

    <!-- Detail/Einträge Drawer -->
    <dialog id="detailDialog" class="w-full max-w-3xl rounded-2xl p-0">
      <form method="dialog" class="p-4 flex justify-between items-start border-b bg-gray-800 text-gray-100">
        <h3 class="text-lg font-semibold">Akte: <span id="detailName"></span></h3>
        <button class="px-3 py-1 rounded-xl bg-gray-700">Schließen</button>
      </form>
      <div class="p-4 grid grid-cols-1 md:grid-cols-3 gap-4 bg-gray-900 text-gray-100">
        <div class="md:col-span-1">
          <div class="bg-gray-800 rounded-xl p-3 border">
            <dl class="text-sm space-y-2">
              <div>
                <dt class="text-gray-400">Telefon</dt>
                <dd id="detailPhone" class="font-medium"></dd>
              </div>
              <div>
                <dt class="text-gray-400">Adresse</dt>
                <dd id="detailAddress" class="font-medium whitespace-pre-wrap"></dd>
              </div>
              <div>
                <dt class="text-gray-400">Fraktion</dt>
                <dd id="detailNotes" class="font-medium whitespace-pre-wrap"></dd>
              </div>
              <div>
                <dt class="text-gray-400">Erstellt</dt>
                <dd id="detailCreated" class="font-medium"></dd>
              </div>
              <div>
                <dt class="text-gray-400">Zuletzt geändert</dt>
                <dd id="detailUpdated" class="font-medium"></dd>
              </div>
            </dl>
          </div>
        </div>
        <div class="md:col-span-2">
          <div class="flex items-center justify-between mb-2">
            <h4 class="font-semibold">Einträge</h4>
            <button id="btnAddLog" class="px-3 py-1 rounded-xl bg-blue-600 text-white">Neuer Eintrag</button>
          </div>
          <ul id="logList" class="space-y-2 max-h-96 overflow-y-auto pr-1"></ul>
        </div>
      </div>
    </dialog>

    <!-- Add/Edit Modal -->
    <dialog id="editDialog" class="w-full max-w-2xl rounded-2xl p-0">
      <form method="dialog" class="p-4 flex justify-between items-start border-b bg-gray-800 text-gray-100">
        <h3 id="editTitle" class="text-lg font-semibold">Neue Person</h3>
        <button class="px-3 py-1 rounded-xl bg-gray-700">Abbrechen</button>
      </form>
      <div class="p-4 bg-gray-900 text-gray-100">
        <form id="editForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <input type="hidden" name="id" />
          <div>
            <label class="block text-sm text-gray-400 mb-1">Name *</label>
            <input name="name" required placeholder="Vor- und Nachname" class="w-full px-3 py-2 rounded-xl border bg-gray-800" />
          </div>
          <div>
            <label class="block text-sm text-gray-400 mb-1">Telefon</label>
            <input name="phone" placeholder="z. B. +49 170 1234567" class="w-full px-3 py-2 rounded-xl border bg-gray-800" />
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm text-gray-400 mb-1">Adresse</label>
            <textarea name="address" rows="2" placeholder="Straße Nr.\nPLZ Ort" class="w-full px-3 py-2 rounded-xl border bg-gray-800"></textarea>
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm text-gray-400 mb-1">Fraktion</label>
            <textarea name="notes" rows="3" placeholder="z. B. Zugehörigkeit, Infos…" class="w-full px-3 py-2 rounded-xl border bg-gray-800"></textarea>
          </div>
          <div class="md:col-span-2 flex justify-end gap-2">
            <button type="submit" class="px-4 py-2 rounded-2xl bg-blue-600 text-white">Speichern</button>
          </div>
        </form>
      </div>
    </dialog>

    <footer class="mt-8 text-center text-xs text-gray-400">
      <p>Aktensystem von der Familie <strong>Shadow</strong> auf den Fivem GTA Roleplay Server BlackIsland Roleplay BIRP</p>
    </footer>
  </div>

  <script>
    // =============================
    // Konfiguration / Supabase
    // =============================
    const $ = (sel, ctx=document) => ctx.querySelector(sel);
    const fmt = (d) => new Date(d).toLocaleString();

    // In LocalStorage hinterlegte Supabase-Creds (per Button "Verbinden" setzen)
    let SUPABASE_URL = localStorage.getItem('AKTE_SUPABASE_URL') || '';
    let SUPABASE_ANON = localStorage.getItem('AKTE_SUPABASE_ANON') || '';

    let sb = null;
    function initClient(){
      if(!SUPABASE_URL || !SUPABASE_ANON){
        console.warn('Supabase noch nicht konfiguriert');
        return null;
      }
      try {
        sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
        return sb;
      } catch (e) {
        console.error('Supabase init fehlgeschlagen', e);
        return null;
      }
    }

    async function configure(){
      const url = prompt('Supabase Project URL', SUPABASE_URL || 'https://xkflcxzifnpkhkmlzdoa.supabase.co');
      if(!url) return;
      const key = prompt('Supabase Anon Public Key', SUPABASE_ANON || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhrZmxjeHppZm5wa2hrbWx6ZG9hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1NjA4MDIsImV4cCI6MjA3MDEzNjgwMn0.QizK419VRChe2lHwF1hBldTnxqV2j1c1moScB_YL-dg');
      if(!key) return;
      localStorage.setItem('AKTE_SUPABASE_URL', url.trim());
      localStorage.setItem('AKTE_SUPABASE_ANON', key.trim());
      SUPABASE_URL = url.trim();
      SUPABASE_ANON = key.trim();
      initClient();
      await refresh();
      alert('Verbunden!');
    }

    // =============================
    // State & Helpers
    // =============================
    let state = { records: [], search: '', sortBy: 'updatedAt-desc' };
    const tableBody = $('#tableBody');
    const count = $('#count');

    function cleanPhone(v){ if(!v) return ''; return v.replace(/[^+\d]/g,'').replace(/^(0{2})(\d)/,'+$2'); }
    function escapeHtml(s){ return String(s).replace(/[&<>\"]{1}/g,(c)=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c])); }

    function mapPerson(row){
      return {
        id: row.id,
        name: row.name || '',
        phone: row.phone || '',
        address: row.address || '',
        notes: row.notes || '', // "Fraktion"
        createdAt: row.created_at,
        updatedAt: row.updated_at
      };
    }

    function matchesSearch(r, q){ if(!q) return true; q=q.toLowerCase(); return [r.name,r.phone,r.notes].filter(Boolean).some(x=>String(x).toLowerCase().includes(q)); }
    function getSorted(records){ const [field,dir]=state.sortBy.split('-'); const mult=dir==='asc'?1:-1; return [...records].sort((a,b)=>{ if(field==='name') return a.name.localeCompare(b.name)*mult; return (new Date(a[field])-new Date(b[field]))*mult; }); }

    function render(){
      const filtered = state.records.filter(r=>matchesSearch(r, state.search));
      const rows = getSorted(filtered).map(r => `
        <tr class="border-t hover:bg-gray-700">
          <td class="px-4 py-3 font-medium">${escapeHtml(r.name)}</td>
          <td class="px-4 py-3">${escapeHtml(r.phone||'')}</td>
          <td class="px-4 py-3">${escapeHtml((r.notes||'').slice(0,80))}${(r.notes&&r.notes.length>80)?'…':''}</td>
          <td class="px-4 py-3 whitespace-nowrap">${fmt(r.updatedAt)}</td>
          <td class="px-4 py-3">
            <div class="flex gap-2">
              <button class="px-3 py-1 rounded-xl bg-gray-800 border" onclick="openDetail('${r.id}')">Details</button>
              <button class="px-3 py-1 rounded-xl bg-gray-800 border" onclick="openEdit('${r.id}')">Bearbeiten</button>
              <button class="px-3 py-1 rounded-xl bg-red-800 text-red-100 border border-red-700" onclick="removeRecord('${r.id}')">Löschen</button>
            </div>
          </td>
        </tr>`).join('');
      tableBody.innerHTML = rows || `<tr><td colspan="5" class="px-4 py-6 text-center text-gray-500">Keine Akten vorhanden – klicke auf <strong>Neue Person</strong>.</td></tr>`;
      count.textContent = filtered.length + ' Akte' + (filtered.length===1?'':'n');
    }

    // =============================
    // CRUD (Supabase)
    // =============================
    async function refresh(){
      if(!sb){ render(); return; }
      const { data, error } = await sb.from('persons').select('*').order('updated_at', { ascending: false });
      if(error){ console.error(error); alert('Fehler beim Laden: '+error.message); return; }
      state.records = data.map(mapPerson);
      render();
    }

    async function createRecord(data){
      if(!sb){ alert('Noch nicht verbunden. Klicke oben auf "Verbinden".'); return; }
      const now = new Date().toISOString();
      const row = { name: data.name.trim(), phone: cleanPhone(data.phone||''), address: (data.address||'').trim(), notes: (data.notes||'').trim(), created_at: now, updated_at: now };
      const { data: inserted, error } = await sb.from('persons').insert(row).select().single();
      if(error){ alert('Speichern fehlgeschlagen: '+error.message); return; }
      await refresh();
    }

    async function updateRecord(id, patch){
      if(!sb){ alert('Nicht verbunden.'); return; }
      const now = new Date().toISOString();
      const row = { name: patch.name?.trim(), phone: cleanPhone(patch.phone||''), address: (patch.address||'').trim(), notes: (patch.notes||'').trim(), updated_at: now };
      const { error } = await sb.from('persons').update(row).eq('id', id);
      if(error){ alert('Aktualisieren fehlgeschlagen: '+error.message); return; }
      await refresh();
    }

    async function removeRecord(id){
      if(!sb){ alert('Nicht verbunden.'); return; }
      if(!confirm('Diese Akte wirklich löschen?')) return;
      const { error } = await sb.from('persons').delete().eq('id', id);
      if(error){ alert('Löschen fehlgeschlagen: '+error.message); return; }
      await refresh();
    }



// =============================
// Einträge/Logs mit Modal & Bearbeiten-Button
// =============================
const detailDialog = $('#detailDialog');
const logList = $('#logList');
let currentDetailId = null;

const logModal = document.createElement('dialog');
logModal.classList.add('p-4', 'rounded-lg', 'bg-gray-900', 'text-white');
logModal.style.maxWidth = '90vw';
logModal.style.maxHeight = '80vh';
document.body.appendChild(logModal);

async function openDetail(id){
  const r = state.records.find(x=>x.id===id);
  if(!r) return;
  currentDetailId = id;
  $('#detailName').textContent = r.name;
  $('#detailPhone').textContent = r.phone || '—';
  $('#detailAddress').textContent = r.address || '—';
  $('#detailNotes').textContent = r.notes || '—';
  $('#detailCreated').textContent = fmt(r.createdAt);
  $('#detailUpdated').textContent = fmt(r.updatedAt);
  await renderLogs(r);
  detailDialog.showModal();
}

async function renderLogs(r){
  if(!sb){ 
    logList.innerHTML = '<li class="text-sm text-gray-400">Nicht verbunden.</li>'; 
    return; 
  }

  const { data, error } = await sb.from('entries')
    .select('*')
    .eq('person_id', r.id)
    .order('created_at', { ascending: false });

  if(error){ 
    logList.innerHTML = '<li class="text-sm text-red-400">Fehler beim Laden der Einträge.</li>'; 
    return; 
  }

  const items = (data||[]).map(l => `
    <li class="bg-gray-800 border rounded-xl p-3">
      <div class="flex items-center justify-between gap-2">
        <span class="text-xs text-gray-400">${fmt(l.created_at)}</span>
        <button class="text-xs px-2 py-1 rounded-lg bg-red-800 text-red-100 border border-red-700" onclick="deleteLog('${l.id}')">Entfernen</button>
      </div>
      <h3 class="mt-2 cursor-pointer text-blue-300 hover:underline" onclick="showLogModal('${l.id}')">
        ${escapeHtml(l.title || '—')}
      </h3>
    </li>
  `).join('');

  logList.innerHTML = items || '<li class="text-sm text-gray-400">Noch keine Einträge.</li>';
}

// Neues Log hinzufügen
async function addLog(){
  if(!currentDetailId) return;

  logModal.style.width = '400px';
  logModal.style.height = '300px';

  logModal.innerHTML = `
    <h2 class="text-lg font-bold mb-2">Neuer Eintrag</h2>
    <input id="logTitle" class="w-full p-2 mb-2 rounded bg-gray-700 text-white" placeholder="Überschrift" />
    <textarea id="logText" class="w-full p-2 mb-2 rounded bg-gray-700 text-white" placeholder="Text" rows="8"></textarea>
    <div class="flex justify-end gap-2">
      <button id="cancelBtn" class="px-3 py-1 rounded bg-gray-600">Abbrechen</button>
      <button id="saveBtn" class="px-3 py-1 rounded bg-blue-600">Speichern</button>
    </div>
  `;
  logModal.showModal();

  $('#cancelBtn').onclick = () => logModal.close();
  $('#saveBtn').onclick = async () => {
    const title = $('#logTitle').value.trim();
    const text = $('#logText').value.trim();
    if(!title || !text){ alert('Bitte Titel und Text ausfüllen'); return; }

    const { error } = await sb.from('entries').insert({ person_id: currentDetailId, title, text });
    if(error){ alert('Eintrag fehlgeschlagen: ' + error.message); return; }

    logModal.close();
    await refresh();
    const rec = state.records.find(x => x.id === currentDetailId);
    if(rec) await renderLogs(rec);
  };
}

// Bestehenden Log anzeigen + Bearbeiten-Button (großes Lesemodal)
async function showLogModal(id){
  const { data, error } = await sb.from('entries').select('*').eq('id', id).single();
  if(error || !data){ return alert('Eintrag nicht gefunden'); }
  const { title, text } = data;

  logModal.style.width = '500px';
  logModal.style.height = '500px';

  logModal.innerHTML = `
    <h2 class="text-lg font-bold mb-2">${escapeHtml(title)}</h2>
    <div style="height: calc(100% - 100px); overflow-y: auto;">
      <p class="whitespace-pre-wrap">${escapeHtml(text)}</p>
    </div>
    <div class="flex justify-end gap-2 mt-2">
      <button id="editBtn" class="px-3 py-1 rounded bg-blue-600">Bearbeiten</button>
      <button id="closeBtn" class="px-3 py-1 rounded bg-gray-600">Schließen</button>
    </div>
  `;
  logModal.showModal();

  $('#closeBtn').onclick = () => logModal.close();
  
  $('#editBtn').onclick = () => editLog(id, title, text);
}

// Bearbeiten-Funktion
function editLog(id, title, text){
  logModal.style.width = '400px';
  logModal.style.height = '300px';

  logModal.innerHTML = `
    <h2 class="text-lg font-bold mb-2">Eintrag bearbeiten</h2>
    <input id="logTitle" class="w-full p-2 mb-2 rounded bg-gray-700 text-white" value="${escapeHtml(title)}" />
    <textarea id="logText" class="w-full p-2 mb-2 rounded bg-gray-700 text-white" rows="8">${escapeHtml(text)}</textarea>
    <div class="flex justify-end gap-2">
      <button id="cancelBtn" class="px-3 py-1 rounded bg-gray-600">Abbrechen</button>
      <button id="saveBtn" class="px-3 py-1 rounded bg-blue-600">Speichern</button>
    </div>
  `;

  $('#cancelBtn').onclick = () => logModal.close();
  $('#saveBtn').onclick = async () => {
    const newTitle = $('#logTitle').value.trim();
    const newText = $('#logText').value.trim();
    if(!newTitle || !newText){ alert('Bitte Titel und Text ausfüllen'); return; }

    const { error } = await sb.from('entries').update({ title: newTitle, text: newText }).eq('id', id);
    if(error){ alert('Speichern fehlgeschlagen: ' + error.message); return; }

    logModal.close();
    const rec = state.records.find(x => x.id === currentDetailId);
    if(rec) await renderLogs(rec);
  };
}

async function deleteLog(logId){
  const { error } = await sb.from('entries').delete().eq('id', logId);
  if(error){ alert('Löschen fehlgeschlagen: '+error.message); return; }
  const rec = state.records.find(x => x.id===currentDetailId);
  if(rec) await renderLogs(rec);
}






    // =============================
    // Export / Import (Supabase)
    // =============================
    async function exportJSON(){
      if(!sb){ alert('Nicht verbunden.'); return; }
      const { data: persons, error: e1 } = await sb.from('persons').select('*');
      const { data: entries, error: e2 } = await sb.from('entries').select('*');
      if(e1||e2){ alert('Export fehlgeschlagen.'); return; }
      const blob = new Blob([JSON.stringify({ persons, entries }, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'akten-export-' + new Date().toISOString().slice(0,10) + '.json';
      a.click();
      URL.revokeObjectURL(url);
    }

    async function importJSON(file){
      const reader = new FileReader();
      reader.onload = async () => {
        try{
          const obj = JSON.parse(reader.result);
          // Alte Form (Array Personen-only) unterstützen
          if(Array.isArray(obj)){
            const persons = obj.map(p=>({ id: p.id, name:p.name, phone:p.phone, address:p.address, notes:p.notes, created_at:p.createdAt, updated_at:p.updatedAt }));
            const { error } = await sb.from('persons').upsert(persons, { onConflict: 'id' });
            if(error) throw error;
          } else {
            const persons = (obj.persons||[]).map(p=>({ id:p.id, name:p.name, phone:p.phone, address:p.address, notes:p.notes, created_at:p.created_at||p.createdAt, updated_at:p.updated_at||p.updatedAt }));
            const entries = (obj.entries||[]).map(e=>({ id:e.id, person_id:e.person_id, text:e.text, created_at:e.created_at }));
            if(persons.length){ const { error } = await sb.from('persons').upsert(persons, { onConflict: 'id' }); if(error) throw error; }
            if(entries.length){ const { error } = await sb.from('entries').upsert(entries, { onConflict: 'id' }); if(error) throw error; }
          }
          await refresh();
          alert('Import abgeschlossen.');
        }catch(err){ alert('Import fehlgeschlagen: ' + (err.message||err)); }
      };
      reader.readAsText(file);
    }

    async function resetAll(){
      if(!sb){ alert('Nicht verbunden.'); return; }
      if(!confirm('WIRKLICH ALLES löschen? (Personen & Einträge)')) return;
      // Reihenfolge: entries -> persons
      await sb.from('entries').delete().neq('id', null);
      await sb.from('persons').delete().neq('id', null);
      await refresh();
    }

    // =============================
    // Realtime
    // =============================
    function initRealtime(){
      if(!sb) return;
      sb.channel('realtime-akte')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'persons' }, payload => { refresh(); })
        .on('postgres_changes', { event: '*', schema: 'public', table: 'entries' }, payload => {
          if(currentDetailId){ const rec = state.records.find(x=>x.id===currentDetailId); if(rec) renderLogs(rec); }
        })
        .subscribe();
    }

    // =============================
    // Add/Edit Modal
    // =============================
    const editDialog = $('#editDialog');
    const editForm = $('#editForm');

    function openEdit(id){
      editForm.reset();
      if(id){
        const r = state.records.find(x=>x.id===id);
        if(!r) return;
        $('#editTitle').textContent = 'Akte bearbeiten';
        editForm.id.value = r.id;
        editForm.name.value = r.name;
        editForm.phone.value = r.phone || '';
        editForm.address.value = r.address || '';
        editForm.notes.value = r.notes || '';
      } else {
        $('#editTitle').textContent = 'Neue Person';
        editForm.id.value = '';
      }
      editDialog.showModal();
    }

    editForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const data = Object.fromEntries(new FormData(editForm).entries());
      if(!data.name || data.name.trim().length<2){ alert('Bitte einen gültigen Namen eingeben.'); return; }
      if(data.phone){ data.phone = cleanPhone(data.phone); }
      if(data.id){ await updateRecord(data.id, data); }
      else { await createRecord(data); }
      editDialog.close();
    });

    // =============================
    // Events & init
    // =============================
    $('#btnConfig').addEventListener('click', configure);
    $('#btnAdd').addEventListener('click', ()=>openEdit());
    $('#btnExport').addEventListener('click', exportJSON);
    $('#btnReset').addEventListener('click', resetAll);
    $('#importFile').addEventListener('change', (e)=>{ const f = e.target.files?.[0]; if(f) importJSON(f); e.target.value=''; });
    $('#search').addEventListener('input', (e)=>{ state.search = e.target.value; render(); });
    $('#sortBy').addEventListener('change', (e)=>{ state.sortBy = e.target.value; render(); });
    $('#btnAddLog').addEventListener('click', (e)=>{ e.preventDefault(); addLog(); });

    // Expose for onclick handlers used in HTML strings
    window.openDetail = openDetail;
    window.openEdit = openEdit;
    window.removeRecord = removeRecord;
    window.deleteLog = deleteLog;

    // Start
    initClient();
    refresh();
    initRealtime();

    // Hinweis beim ersten Start ohne Konfiguration
    if(!SUPABASE_URL || !SUPABASE_ANON){
      setTimeout(()=>{
        alert('Supabase ist noch nicht konfiguriert. Klicke oben auf "Verbinden" und trage URL & Anon Key ein.');
      }, 200);
    }
  </script>
</body>
</html>
