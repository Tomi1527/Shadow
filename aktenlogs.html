<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Änderungs-Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
  if(sessionStorage.getItem('loggedIn') !== 'true'){
    window.location.href = "index.html";
  }
</script>
</head>
<body class="bg-gray-900 text-gray-100">
  <div class="max-w-7xl mx-auto p-6">
    <h1 class="text-2xl font-bold mb-6">Änderungs-Dashboard</h1>
    <table class="min-w-full border border-gray-700 rounded-xl overflow-hidden">
      <thead class="bg-gray-700 text-sm sticky top-0 z-10">
        <tr>
          <th class="px-3 py-2 text-left">Zeitpunkt</th>
          <th class="px-3 py-2 text-left">User</th>
          <th class="px-3 py-2 text-left">Tabelle</th>
          <th class="px-3 py-2 text-left">Aktion</th>
          <th class="px-3 py-2 text-left">Vorher/Nachher</th>
        </tr>
      </thead>
      <tbody id="logTable" class="divide-y divide-gray-700 text-sm"></tbody>
    </table>
  </div>

  <script>
  const SUPABASE_URL = "https://xkflcxzifnpkhkmlzdoa.supabase.co";
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhrZmxjeHppZm5wa2hrbWx6ZG9hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1NjA4MDIsImV4cCI6MjA3MDEzNjgwMn0.QizK419VRChe2lHwF1hBldTnxqV2j1c1moScB_YL-dg";
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
  const logTable = document.getElementById('logTable');

  function fmt(d){ return new Date(d).toLocaleString(); }

  function safeParse(json){
    if(!json) return null;
    if(typeof json === 'string'){
      try { return JSON.parse(json); } catch(err){ return json; }
    }
    return json;
  }

  async function fetchPersonName(personId) {
    if (!personId) return null;
    const { data, error } = await sb
      .from('persons') 
      .select('name')
      .eq('id', personId)
      .single();
    return error ? null : data.name;
  }


  async function renderData(obj, type='person'){
    obj = safeParse(obj);
    if(!obj) return '—';

    if(type === 'entry'){
      let personName = obj.person_id ? await fetchPersonName(obj.person_id) : null;
      const fields = [
        ['Titel', obj.title],
        ['Text', obj.text],
        ['Person', personName]
      ];
      return fields.filter(([_, val]) => val).map(([label,val]) => `<strong>${label}:</strong> ${val}`).join('<br>');
    }


    const fields = [
      ['Name', obj.name],
      ['Tel.', obj.phone],
      ['Fraktion', obj.notes]
    ];
    return fields.filter(([_, val]) => val).map(([label,val]) => `<strong>${label}:</strong> ${val}`).join('<br>');
  }

 
  async function renderDetails(table, oldData, newData){
    const type = table==='entries' ? 'entry' : 'person';
    const oldHtml = await renderData(oldData, type);
    const newHtml = await renderData(newData, type);

    return `
      <div class="grid grid-cols-2 gap-4">
        <div><span class="text-gray-400">Vorher:</span><br>${oldHtml}</div>
        <div><span class="text-gray-400">Nachher:</span><br>${newHtml}</div>
      </div>
    `;
  }


  async function loadLogs(){
    const { data, error } = await sb
      .from('audit_logs')
      .select('*')
      .order('created_at', { ascending: false })
      .limit(100);

    if(error){
      logTable.innerHTML = `<tr><td colspan="5" class="px-3 py-2 text-red-400">Fehler: ${error.message}</td></tr>`;
      return;
    }

    logTable.innerHTML = '';

    for(const l of data){
      let details = await renderDetails(l.table_name, l.old_data, l.new_data);

      const row = document.createElement('tr');
      row.className = 'hover:bg-gray-800 transition-colors duration-150';
      row.innerHTML = `
        <td class="px-3 py-2 whitespace-nowrap">${fmt(l.created_at)}</td>
        <td class="px-3 py-2">${l.username || '—'}</td>
        <td class="px-3 py-2">${l.table_name}</td>
        <td class="px-3 py-2">${l.action}</td>
        <td class="px-3 py-2 text-xs break-words">${details}</td>
      `;
      logTable.appendChild(row);
    }
  }

  loadLogs();
</script>

</body>
</html>

